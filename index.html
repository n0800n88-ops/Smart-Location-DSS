<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Decision Support System - Smart Location Simulation</title>
    <style>
      /* ================= Layout Settings ================= */
      body, html { height: 100%; margin: 0; padding: 0; font-family: "Segoe UI", "Roboto", "Helvetica", Arial, sans-serif; }
      
      /* Sidebar */
      #sidebar {
        height: 100%;
        width: 400px;
        position: absolute;
        top: 0;
        left: 0;
        z-index: 10;
        background-color: #fcfcfc;
        box-shadow: 2px 0 8px rgba(0,0,0,0.15);
        overflow-y: auto;
        padding: 20px;
        box-sizing: border-box;
        border-right: 1px solid #e0e0e0;
      }

      /* Map */
      #map {
        height: 100%;
        width: calc(100% - 400px);
        margin-left: 400px;
        float: left;
      }

      /* ================= Styles ================= */
      /* Title Area with Language Switcher */
      .header-container {
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 3px solid #3498db;
        padding-bottom: 10px;
        margin-bottom: 20px;
      }
      
      h3 { 
        color: #2c3e50; 
        margin: 0; 
        font-size: 1.4em;
        line-height: 1.3;
      }

      .lang-switch {
        cursor: pointer;
        font-size: 1.2em;
        position: relative;
        display: flex;
        align-items: center;
        gap: 5px;
        padding: 5px;
        border-radius: 5px;
        transition: background 0.2s;
        /* è®“é¸å–®èƒ½æµ®åœ¨å…¶ä»–å…§å®¹ä¹‹ä¸Š */
        z-index: 101; 
      }
      .lang-switch:hover { background-color: #eee; }
      
      .lang-menu {
        display: none;
        position: absolute;
        top: 100%;
        right: 0;
        background: white;
        border: 1px solid #ddd;
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        border-radius: 4px;
        z-index: 102;
        width: 120px;
      }
      .lang-menu div {
        padding: 10px;
        cursor: pointer;
        font-size: 0.9em;
      }
      .lang-menu div:hover { background-color: #f5f5f5; }
      .show-menu { display: block; }

      /* --- Details / Accordion (Step 1~3) --- */
      details {
        margin-bottom: 15px;
        background-color: #fff;
        border: 1px solid #ddd;
        border-radius: 4px;
        overflow: hidden;
      }

      summary {
        cursor: pointer;
        outline: none;
        list-style: none;
        margin: 0;
        color: #34495e;
        font-size: 1.1em;
        font-weight: bold;
        border-left: 5px solid #e67e22;
        padding: 10px;
        background-color: #f5f5f5;
        border-bottom: 1px solid transparent;
        transition: background-color 0.2s;
      }

      summary:hover { background-color: #eee; }
      details[open] summary { border-bottom: 1px solid #ddd; }
      summary::after { content: "â–¼"; float: right; margin-right: 5px; font-size: 0.8em; color: #999; }
      details[open] summary::after { content: "â–²"; }
      
      .details-content { padding: 15px; }
      summary::-webkit-details-marker { display: none; }

      /* --- Guide Section --- */
      .guide-details { margin-bottom: 15px; border: 1px solid #b3e5fc; border-radius: 6px; padding: 10px; background-color: #e1f5fe; }
      .guide-summary { cursor: pointer; font-weight: bold; color: #0277bd; outline: none; list-style: none; background-color: transparent; border: none; padding: 0; font-size: 0.95em; }
      .guide-summary:hover { background-color: transparent !important; }
      .guide-summary::after { content: " â–¼"; float: none; color: #0277bd; }
      .guide-details[open] .guide-summary::after { content: " â–²"; }
      .guide-content { font-size: 0.9em; line-height: 1.6; color: #455a64; margin-top: 10px; background-color: #fff; padding: 10px; border-radius: 4px;}
      .guide-highlight { font-weight: bold; color: #d35400; background-color: #fff3e0; padding: 2px 5px; border-radius: 3px;}

      /* --- Sliders --- */
      .control-group { margin-bottom: 12px; }
      .control-group label { display: block; font-weight: bold; font-size: 0.95em; margin-bottom: 4px; color: #2c3e50;}
      .control-group small { font-size: 0.8em; font-weight: normal; margin-left: 5px; }
      .benefit { color: #27ae60; font-weight: bold; }
      .cost { color: #c0392b; font-weight: bold; }
      input[type=range] { width: 100%; cursor: pointer; accent-color: #3498db; }

      /* --- Input Forms --- */
      .input-group { margin-bottom: 10px; }
      .input-group label { display: block; font-size: 0.9em; color: #333; margin-bottom: 3px; font-weight: bold;}
      .input-group input { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; font-size: 0.9em; }
      .input-group input:focus { border-color: #3498db; outline: none; }

      /* Editing Mode */
      .editing-mode { border: 2px solid #f39c12; background-color: #fffaf0; padding: 10px; border-radius: 5px; position: relative;}
      .editing-label { display: none; background: #f39c12; color: #fff; padding: 2px 8px; font-size: 0.8em; border-radius: 3px; margin-bottom: 5px; width: fit-content;}
      
      /* --- Buttons --- */
      .btn { width: 100%; padding: 12px; background-color: #2ecc71; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 1em; margin-top: 10px; transition: 0.3s; font-weight: bold; }
      .btn:hover { filter: brightness(90%); box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
      .btn-add { background-color: #2ecc71; }
      .btn-update { background-color: #f39c12; display: none; }
      .btn-cancel { background-color: #95a5a6; width: 48%; float: right; margin-top: 10px; display: none;}
      .btn-reset { background-color: #7f8c8d; margin-top: 15px; font-size: 0.9em; width: 100%;}
      
      /* --- Ranking List --- */
      #ranking-list { margin-top: 0; font-size: 0.95em; }
      .rank-item { padding: 10px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; background-color: #fff; }
      .rank-item:first-child { background-color: #fff8e1; border: 2px solid #ffe0b2; border-radius: 4px;}
      .rank-info { flex-grow: 1; }
      .rank-actions { display: flex; gap: 5px; }
      .action-btn { padding: 4px 8px; border: none; border-radius: 3px; cursor: pointer; font-size: 0.85em; transition: 0.2s; }
      .btn-edit { background-color: #f1c40f; color: #fff; }
      .btn-edit:hover { background-color: #f39c12; }
      .btn-del { background-color: #e74c3c; color: #fff; }
      .btn-del:hover { background-color: #c0392b; }
      .user-added { color: #2980b9; font-weight: bold; background-color: #e8f4f8; }
      .rank-score { font-family: monospace; font-size: 1.1em; font-weight: bold; color: #555;}
    </style>
  </head>
  
  <body>
    
    <div id="sidebar">
      <div class="header-container">
        <h3 data-i18n="title">DSS - Smart Location</h3>
        
        <div class="lang-switch" onclick="toggleLangMenu(event)" onmouseleave="closeLangMenu()">
          ğŸŒ <span id="current-lang-text">EN</span>
          <div class="lang-menu" id="lang-menu">
            <div onclick="setLanguage('en', event)">English</div>
            <div onclick="setLanguage('tw', event)">ç¹é«”ä¸­æ–‡</div>
          </div>
        </div>
      </div>

      <details class="guide-details"> 
        <summary class="guide-summary" data-i18n="guide_title">ğŸ’¡ Newbie Guide: Strategies</summary>
        <div class="guide-content" id="guide-content">
          </div>
      </details>

      <details open>
        <summary data-i18n="step1">Step 1: Set Preferences</summary>
        <div class="details-content">
          <div class="control-group">
            <label><span data-i18n="w_pop">1. Pop. Density</span> <small class="benefit" data-i18n="high">(High)</small> <span id="v-pop" style="float:right">0.14</span></label>
            <input type="range" id="w-pop" min="0" max="1" step="0.01" value="0.139">
          </div>
          <div class="control-group">
            <label><span data-i18n="w_rent">2. Rent Cost</span> <small class="cost" data-i18n="low">(Low)</small> <span id="v-rent" style="float:right">0.10</span></label>
            <input type="range" id="w-rent" min="0" max="1" step="0.01" value="0.097">
          </div>
          <div class="control-group">
            <label><span data-i18n="w_traf">3. Traffic</span> <small class="benefit" data-i18n="high">(High)</small> <span id="v-traf" style="float:right">0.26</span></label>
            <input type="range" id="w-traf" min="0" max="1" step="0.01" value="0.262">
          </div>
          <div class="control-group">
            <label><span data-i18n="w_comp">4. Competition</span> <small class="cost" data-i18n="low">(Low)</small> <span id="v-comp" style="float:right">0.09</span></label>
            <input type="range" id="w-comp" min="0" max="1" step="0.01" value="0.089">
          </div>
          <div class="control-group">
            <label><span data-i18n="w_mat">5. Maturity</span> <small class="benefit" data-i18n="high">(High)</small> <span id="v-mat" style="float:right">0.41</span></label>
            <input type="range" id="w-mat" min="0" max="1" step="0.01" value="0.413">
          </div>
        </div>
      </details>

      <details id="step2-panel">
        <summary data-i18n="step2">Step 2: Add Location</summary>
        <div class="details-content">
          <p style="font-size:0.85em; color:#666; margin-bottom:10px;" data-i18n="step2_desc">ğŸ‘‡ Click on map or input manually</p>
          
          <div id="form-container">
            <div class="editing-label" id="edit-label" data-i18n="editing_warn">âš ï¸ Editing Mode</div>
            
            <div class="input-group">
              <label data-i18n="input_name">Location Name</label>
              <input type="text" id="new-name">
            </div>
            
            <div style="display:flex; gap:10px;">
              <div class="input-group" style="flex:1">
                <label>Lat</label>
                <input type="text" id="new-lat" readonly style="background-color:#f9f9f9;">
              </div>
              <div class="input-group" style="flex:1">
                <label>Lng</label>
                <input type="text" id="new-lng" readonly style="background-color:#f9f9f9;">
              </div>
            </div>

            <div class="input-group">
              <label data-i18n="input_pop">Pop. Density (p/kmÂ²)</label>
              <input type="number" id="new-pop">
            </div>
            <div class="input-group">
              <label data-i18n="input_rent">Avg Rent ($/ping)</label>
              <input type="number" id="new-rent">
            </div>
            <div class="input-group">
              <label data-i18n="input_traf">Transit Stations</label>
              <input type="number" id="new-traf">
            </div>
            <div class="input-group">
              <label data-i18n="input_comp">Competitors</label>
              <input type="number" id="new-comp">
            </div>
            <div class="input-group">
              <label data-i18n="input_mat">Maturity (1-10)</label>
              <input type="number" id="new-mat">
            </div>

            <button id="btn-add" class="btn btn-add" onclick="handleSave()" data-i18n="btn_add">âœš Add Location</button>
            
            <div style="overflow:hidden;">
              <button id="btn-update" class="btn btn-update" style="width:48%; float:left;" onclick="handleSave()" data-i18n="btn_update">ğŸ’¾ Update</button>
              <button id="btn-cancel" class="btn btn-cancel" onclick="cancelEditMode()" data-i18n="btn_cancel">Cancel</button>
            </div>
          </div>
        </div>
      </details>

      <details open>
        <summary data-i18n="step3">Step 3: Ranking</summary>
        <div class="details-content">
          <div id="ranking-list"></div>
        </div>
      </details>
      <button class="btn btn-reset" onclick="resetLocations()" data-i18n="btn_reset">â†º Reset All Data</button>
    </div>

    <div id="map"></div>

    <script>
      let map, heatmap;
      let markers = []; 
      let editIndex = -1; 
      let selectionMarker = null; 
      let currentLang = 'en'; 

      const translations = {
        en: {
            title: "DSS - Smart Location",
            guide_title: "ğŸ’¡ Beginner's Guide: Strategies",
            guide_html: `<p>Try these common strategies:</p>
              <ul>
                <li><span class="guide-highlight">ğŸ’° Low Budget</span>:<br>Increase <b class="cost">Rent</b> & <b class="cost">Competition</b>. (Find cheap & less rivals)</li>
                <li><span class="guide-highlight">ğŸƒ High Traffic</span>:<br>Increase <b class="benefit">Pop. Density</b> & <b class="benefit">Traffic</b>. (Crowds first)</li>
                <li><span class="guide-highlight">ğŸ’ Premium</span>:<br>Increase <b class="benefit">Maturity</b>. (Prime locations)</li>
              </ul>`,
            step1: "Step 1: Set Preferences",
            step2: "Step 2: Add Location",
            step3: "Step 3: Ranking",
            w_pop: "1. Pop. Density",
            w_rent: "2. Rent Cost",
            w_traf: "3. Traffic",
            w_comp: "4. Competition",
            w_mat: "5. Maturity",
            high: "(High)",
            low: "(Low)",
            step2_desc: "ğŸ‘‡ Click on map or input manually",
            editing_warn: "âš ï¸ Editing Mode...",
            input_name: "Location Name",
            input_pop: "Pop. Density (p/kmÂ²)",
            input_rent: "Avg Rent ($/ping)",
            input_traf: "Transit Stations",
            input_comp: "Competitors",
            input_mat: "Maturity (1-10)",
            btn_add: "âœš Add Location",
            btn_update: "ğŸ’¾ Update",
            btn_cancel: "Cancel",
            btn_reset: "â†º Reset All Data",
            ph_name: "Ex: Neihu Store",
            ph_lat: "Click map to fill",
            ph_pop: "Ex: Xinyi ~18000",
            ph_rent: "Ex: Da'an ~3700",
            ph_traf: "Ex: MRT+Bus ~260",
            ph_comp: "Ex: Xinyi ~70",
            ph_mat: "Ex: Xinyi 9",
            alert_loc: "Please click on the map first!",
            alert_del: "Are you sure you want to delete ",
            alert_reset: "Are you sure you want to reset all data?",
            default_name: "New Location"
        },
        tw: {
            title: "æ±ºç­–æ”¯æ´ç³»çµ± - é¸å€æ¨¡æ“¬",
            guide_title: "ğŸ’¡ æˆ‘æ˜¯æ–°æ‰‹ï¼Œè©²æ€éº¼èª¿æ¬Šé‡ï¼Ÿ",
            guide_html: `<p>è«‹åƒè€ƒé€™ä¸‰ç¨®å¸¸è¦‹ç­–ç•¥ï¼š</p>
              <ul>
                <li><span class="guide-highlight">ğŸ’° å°è³‡å‰µæ¥­</span>ï¼š<br>èª¿é«˜ <b class="cost">ç§Ÿé‡‘</b> èˆ‡ <b class="cost">ç«¶çˆ­</b>ã€‚(æ‰¾ä¾¿å®œã€å°æ‰‹å°‘çš„)</li>
                <li><span class="guide-highlight">ğŸƒ äººæµè‡³ä¸Š</span>ï¼š<br>èª¿é«˜ <b class="benefit">äººå£</b> èˆ‡ <b class="benefit">äº¤é€š</b>ã€‚(äººå¤šæœ€é‡è¦)</li>
                <li><span class="guide-highlight">ğŸ’ å“ç‰Œæ——è‰¦</span>ï¼š<br>èª¿é«˜ <b class="benefit">å•†åœˆæˆç†Ÿ</b>ã€‚(è¦æœ€çŸ¥ååœ°æ®µ)</li>
              </ul>`,
            step1: "Step 1: è¨­å®šæ¬Šé‡åå¥½",
            step2: "Step 2: æ–°å¢æ¨¡æ“¬åœ°é»",
            step3: "Step 3: è©•åˆ†æ’å",
            w_pop: "1. äººå£å¯†åº¦",
            w_rent: "2. ç§Ÿé‡‘æˆæœ¬",
            w_traf: "3. äº¤é€šä¾¿åˆ©",
            w_comp: "4. ç«¶çˆ­å¯†åº¦",
            w_mat: "5. å•†åœˆæˆç†Ÿ",
            high: "(é«˜)",
            low: "(ä½)",
            step2_desc: "ğŸ‘‡ åœ¨åœ°åœ–ä¸Šé»ä¸€ä¸‹ï¼Œæˆ–æ‰‹å‹•è¼¸å…¥æ•¸æ“š",
            editing_warn: "âš ï¸ æ­£åœ¨ç·¨è¼¯ä¸­...",
            input_name: "åœ°é»åç¨±",
            input_pop: "äººå£å¯†åº¦ (äºº/kmÂ²)",
            input_rent: "å¹³å‡ç§Ÿé‡‘ (å…ƒ/åª)",
            input_traf: "äº¤é€šç¸½ç«™æ•¸ (æ·é‹+å…¬è»Š)",
            input_comp: "ç«¶çˆ­åº—æ•¸",
            input_mat: "å•†åœˆæˆç†Ÿåº¦ (1-10)",
            btn_add: "âœš åŠ å…¥æ¨¡æ“¬",
            btn_update: "ğŸ’¾ æ›´æ–°è³‡æ–™",
            btn_cancel: "å–æ¶ˆ",
            btn_reset: "â†º é‡ç½®æ‰€æœ‰è³‡æ–™",
            ph_name: "ä¾‹å¦‚ï¼šå…§æ¹–åº—",
            ph_lat: "é»åœ°åœ–è‡ªå‹•å¡«",
            ph_pop: "åƒè€ƒï¼šä¿¡ç¾©ç´„18000",
            ph_rent: "åƒè€ƒï¼šå¤§å®‰ç´„3700",
            ph_traf: "ä¾‹å¦‚ï¼šæ·é‹10+å…¬è»Š250=260",
            ph_comp: "åƒè€ƒï¼šä¿¡ç¾©ç´„70",
            ph_mat: "åƒè€ƒï¼šä¿¡ç¾©9åˆ†",
            alert_loc: "è«‹å…ˆé»æ“Šåœ°åœ–è¨­å®šä½ç½®ï¼",
            alert_del: "ç¢ºå®šè¦åˆªé™¤",
            alert_reset: "ç¢ºå®šè¦é‡ç½®æ‰€æœ‰è³‡æ–™å—ï¼Ÿ",
            default_name: "æ–°åœ°é»"
        }
      };
      
      const defaultDistricts = [
        { name: "Xinyi District", name_tw: "ä¿¡ç¾©å€", lat: 25.033964, lng: 121.564468, raw: { pop: 17995.57, rent: 2618, traf: 214, comp: 70, mat: 9 }, isUser: false },
        { name: "Da'an District", name_tw: "å¤§å®‰å€", lat: 25.034180, lng: 121.543460, raw: { pop: 24858.97, rent: 3715, traf: 264, comp: 236, mat: 8 }, isUser: false },
        { name: "Zhongshan Dist.", name_tw: "ä¸­å±±å€", lat: 25.068500, lng: 121.527600, raw: { pop: 15522.18, rent: 2638, traf: 297, comp: 174, mat: 7 }, isUser: false }
      ];

      let currentDistricts = JSON.parse(JSON.stringify(defaultDistricts));

      const indicators = {
        pop:  { type: 1 }, rent: { type: -1 }, traf: { type: 1 }, comp: { type: -1 }, mat:  { type: 1 }
      };

      // --- ä¿®æ”¹å¾Œçš„èªè¨€åˆ‡æ›é‚è¼¯ ---
      
      function toggleLangMenu(e) {
        if(e) e.stopPropagation(); 
        document.getElementById('lang-menu').classList.toggle('show-menu');
      }

      function closeLangMenu() {
        // æ»‘é¼ é›¢é–‹æ™‚å‘¼å«æ­¤å‡½å¼ï¼Œé—œé–‰é¸å–®
        document.getElementById('lang-menu').classList.remove('show-menu');
      }

      function setLanguage(lang, e) {
        if(e) e.stopPropagation(); 
        currentLang = lang;
        document.getElementById('current-lang-text').innerText = lang === 'en' ? 'EN' : 'TW';
        
        closeLangMenu(); // é¸å®Œå¾Œç›´æ¥é—œé–‰

        const t = translations[lang];

        document.querySelectorAll('[data-i18n]').forEach(el => {
            const key = el.getAttribute('data-i18n');
            if (t[key]) el.innerText = t[key];
        });

        document.getElementById('guide-content').innerHTML = t.guide_html;

        document.getElementById('new-name').placeholder = t.ph_name;
        document.getElementById('new-lat').placeholder = t.ph_lat;
        document.getElementById('new-lng').placeholder = t.ph_lat;
        document.getElementById('new-pop').placeholder = t.ph_pop;
        document.getElementById('new-rent').placeholder = t.ph_rent;
        document.getElementById('new-traf').placeholder = t.ph_traf;
        document.getElementById('new-comp').placeholder = t.ph_comp;
        document.getElementById('new-mat').placeholder = t.ph_mat;

        runTOPSIS();
      }

      function initMap() {
        map = new google.maps.Map(document.getElementById('map'), {
          zoom: 12, center: {lat: 25.05, lng: 121.54}, mapTypeId: 'roadmap',
          styles: [{ featureType: "poi", elementType: "labels", stylers: [{ visibility: "off" }] }]
        });

        heatmap = new google.maps.visualization.HeatmapLayer({
          data: [], map: map, radius: 70, opacity: 0.85
        });

        map.addListener("click", (e) => {
          document.getElementById('new-lat').value = e.latLng.lat().toFixed(6);
          document.getElementById('new-lng').value = e.latLng.lng().toFixed(6);
   
          document.getElementById('step2-panel').open = true;

          if (selectionMarker) {
            selectionMarker.setMap(null);
          }
          selectionMarker = new google.maps.Marker({
            position: e.latLng, map: map, 
            title: currentLang === 'en' ? "Selected Location" : "ç›®å‰é¸æ“‡ä½ç½®", 
            animation: google.maps.Animation.DROP
          });
        });

        ['pop', 'rent', 'traf', 'comp', 'mat'].forEach(key => {
          document.getElementById('w-' + key).addEventListener('input', function() {
            document.getElementById('v-' + key).innerText = this.value;
            runTOPSIS();
          });
        });

        setLanguage('en'); 
      }

      function runTOPSIS() {
        let W = {
          pop: parseFloat(document.getElementById('w-pop').value),
          rent: parseFloat(document.getElementById('w-rent').value),
          traf: parseFloat(document.getElementById('w-traf').value),
          comp: parseFloat(document.getElementById('w-comp').value),
          mat: parseFloat(document.getElementById('w-mat').value)
        };

        // 1. Normalize
        let denominators = {};
        for(let key in indicators) {
          let sumSquares = currentDistricts.reduce((sum, d) => sum + Math.pow(d.raw[key], 2), 0);
          denominators[key] = Math.sqrt(sumSquares);
        }

        let weightedData = [];
        let PIS = {}, NIS = {}; 
        for(let key in indicators) { PIS[key] = -Infinity; NIS[key] = Infinity; }

        currentDistricts.forEach((d, index) => {
          let row = { ...d, weighted: {}, id: index }; 
          for(let key in indicators) {
            let val = (d.raw[key] / denominators[key]) * W[key];
            row.weighted[key] = val;
            if(val > PIS[key]) PIS[key] = val;
            if(val < NIS[key]) NIS[key] = val;
          }
          weightedData.push(row);
        });

        let realPIS = {}, realNIS = {};
        for(let key in indicators) {
          if(indicators[key].type === 1) { realPIS[key] = PIS[key]; realNIS[key] = NIS[key]; }
          else { realPIS[key] = NIS[key]; realNIS[key] = PIS[key]; }
        }

        // 2. Score Calculation
        let results = [];
        weightedData.forEach((d) => {
          let distPlus = 0, distMinus = 0;
          for(let key in indicators) {
            distPlus += Math.pow(d.weighted[key] - realPIS[key], 2);
            distMinus += Math.pow(d.weighted[key] - realNIS[key], 2);
          }
          let S_plus = Math.sqrt(distPlus);
          let S_minus = Math.sqrt(distMinus);
          let score = (S_plus + S_minus) === 0 ? 0 : S_minus / (S_plus + S_minus);
          
          results.push({ ...d, score });
        });

        // 3. Draw Heatmap
        let heatPoints = [];
        let ranking = [];
        
        markers.forEach(m => m.setMap(null));
        markers = [];

        results.forEach((item) => {
          heatPoints.push({ location: new google.maps.LatLng(item.lat, item.lng), weight: item.score * 40 });
          ranking.push({ 
              id: item.id, 
              name: (currentLang === 'en' && item.name_tw) ? item.name : (currentLang === 'tw' && item.name_tw ? item.name_tw : item.name),
              score: item.score, 
              isUser: item.isUser 
          });
        });

        heatmap.setData(heatPoints);
        updateRankingUI(ranking);
      }

      function updateRankingUI(ranking) {
        ranking.sort((a, b) => b.score - a.score);
        
        let html = "";
        ranking.forEach((item, i) => {
          let icon = (i===0) ? "ğŸ‘‘" : `#${i+1}`;
          let bgClass = item.isUser ? "user-added" : "";
          
          let t = translations[currentLang];
          let actions = `
            <div class="rank-actions">
              <button class="action-btn btn-edit" onclick="editLocation(${item.id})" title="Edit">âœï¸</button>
              <button class="action-btn btn-del" onclick="deleteLocation(${item.id})" title="Delete">ğŸ—‘ï¸</button>
            </div>
          `;

          html += `
            <div class="rank-item ${bgClass}">
              <div class="rank-info">
                <span>${icon} ${item.name}</span> <br>
                <span class="rank-score">Score: ${item.score.toFixed(4)}</span>
              </div>
              ${actions}
            </div>
          `;
        });
        document.getElementById('ranking-list').innerHTML = html;
      }

      function handleSave() {
        let t = translations[currentLang];
        let name = document.getElementById('new-name').value;
        let lat = parseFloat(document.getElementById('new-lat').value);
        let lng = parseFloat(document.getElementById('new-lng').value);
        
        if(!name) name = t.default_name;
        if(isNaN(lat) || isNaN(lng)) { alert(t.alert_loc); return; }
        
        let raw = {
          pop: parseFloat(document.getElementById('new-pop').value) || 0,
          rent: parseFloat(document.getElementById('new-rent').value) || 0,
          traf: parseFloat(document.getElementById('new-traf').value) || 0,
          comp: parseFloat(document.getElementById('new-comp').value) || 0,
          mat: parseFloat(document.getElementById('new-mat').value) || 0
        };

        if(editIndex === -1) {
          currentDistricts.push({ name, lat, lng, raw, isUser: true });
        } else {
          currentDistricts[editIndex] = { ...currentDistricts[editIndex], name, lat, lng, raw, isUser: true }; 
          cancelEditMode(); 
        }
        
        if (selectionMarker) {
          selectionMarker.setMap(null);
          selectionMarker = null;
        }
        
        runTOPSIS();
        clearForm();
        
        document.getElementById('step2-panel').open = false;
      }

      function editLocation(index) {
        let d = currentDistricts[index];
        editIndex = index;

        let displayName = d.name;
        if(currentLang === 'tw' && d.name_tw) displayName = d.name_tw;

        document.getElementById('new-name').value = displayName;
        document.getElementById('new-lat').value = d.lat;
        document.getElementById('new-lng').value = d.lng;
        document.getElementById('new-pop').value = d.raw.pop;
        document.getElementById('new-rent').value = d.raw.rent;
        document.getElementById('new-traf').value = d.raw.traf;
        document.getElementById('new-comp').value = d.raw.comp;
        document.getElementById('new-mat').value = d.raw.mat;

        document.getElementById('form-container').classList.add('editing-mode');
        document.getElementById('edit-label').style.display = 'block';
        document.getElementById('btn-add').style.display = 'none';
        document.getElementById('btn-update').style.display = 'block';
        document.getElementById('btn-cancel').style.display = 'block';

        document.getElementById('step2-panel').open = true;
      }

      function cancelEditMode() {
        editIndex = -1;
        clearForm();
        if (selectionMarker) {
          selectionMarker.setMap(null);
          selectionMarker = null;
        }
   
        document.getElementById('form-container').classList.remove('editing-mode');
        document.getElementById('edit-label').style.display = 'none';
        document.getElementById('btn-add').style.display = 'block';
        document.getElementById('btn-update').style.display = 'none';
        document.getElementById('btn-cancel').style.display = 'none';
        
        document.getElementById('step2-panel').open = false;
      }

      function deleteLocation(index) {
        let t = translations[currentLang];
        let dName = currentLang === 'tw' && currentDistricts[index].name_tw ? currentDistricts[index].name_tw : currentDistricts[index].name;
        
        if(!confirm(`${t.alert_del} "${dName}"?`)) return;
        if(index === editIndex) cancelEditMode();
        currentDistricts.splice(index, 1);
        runTOPSIS();
      }

      function clearForm() {
        document.getElementById('new-name').value = "";
        document.getElementById('new-pop').value = "";
        document.getElementById('new-rent').value = "";
        document.getElementById('new-traf').value = "";
        document.getElementById('new-comp').value = "";
        document.getElementById('new-mat').value = "";
        document.getElementById('new-lat').value = "";
        document.getElementById('new-lng').value = "";
      }

      function resetLocations() {
        let t = translations[currentLang];
        if(!confirm(t.alert_reset)) return;
        currentDistricts = JSON.parse(JSON.stringify(defaultDistricts));
        cancelEditMode();
        runTOPSIS();
      }
    </script>
    
    <script async defer
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBXcaJqg9l4PHdrMZmM3GpWH749oW3wBt8&libraries=visualization&language=en&callback=initMap">
    </script>
  </body>
</html>